<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- é€‚é…å…¨å± App æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#333">
    <title>çˆ±çš„æ—…é€” - Chapter 2</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #333; font-family: "Microsoft YaHei", sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        canvas { display: block; width: 100%; height: 100%; }

        /* UI */
        #game-ui { 
            display: none; 
            position: absolute; top: 10px; left: 10px; z-index: 10; 
            font-weight: bold; color: white; text-shadow: 1px 1px 2px black; width: 90%; 
        }
        .bar-row { display: flex; align-items: center; margin-bottom: 5px; }
        .bar-label { width: 60px; font-size: 14px; }
        .bar-container { flex-grow: 1; height: 12px; background: rgba(0,0,0,0.5); border: 2px solid white; border-radius: 10px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.2s; }
        #hp-fill { background: #ff4757; }
        #energy-fill { background: #eccc68; } 

        /* å­—å¹• */
        #subtitle {
            position: absolute; bottom: 35%; width: 100%; padding: 0 20px; box-sizing: border-box; text-align: center;
            color: white; font-size: 18px; line-height: 1.4; text-shadow: 0 2px 4px rgba(0,0,0,0.9);
            pointer-events: none; z-index: 20; transition: opacity 0.5s; opacity: 0;
        }

        /* è½¬åœº & ç»“å±€ */
        #transition-layer {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(#a18cd1, #fbc2eb);
            z-index: 50; opacity: 0; transition: opacity 2s;
            flex-direction: column; justify-content: center; align-items: center;
            background-size: cover; background-position: center;
        }

        /* é€‰æ‹©æŒ‰é’® */
        #choice-container { margin-top: 200px; position: relative; width: 300px; height: 100px; display: none; }
        .choice-btn {
            position: absolute; padding: 10px 30px; border-radius: 20px; border: none; font-size: 18px; cursor: pointer; color: white; font-weight: bold; transition: all 0.2s;
        }
        #btn-yes { background: #ff4757; left: 30px; bottom: 20px; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4); }
        #btn-no { background: #747d8c; right: 30px; bottom: 20px; }

        /* ä¿¡ä»¶ç›¸å…³æ ·å¼ */
        #letter-layer {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 150; display: flex; justify-content: center; align-items: center;
        }
        #letter-paper {
            width: 85%; max-width: 500px; height: 75%; background: #fffdf0;
            padding: 20px 25px; box-sizing: border-box; border-radius: 5px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); font-family: sans-serif;
            color: #333; line-height: 1.6; font-size: 15px; position: relative;
            transform: scale(0.1); transition: transform 0.5s; overflow-y: auto;
            display: flex; flex-direction: column;
        }
        /* ä¿¡ä»¶æ®µè½åŠ¨ç”» */
        .letter-p {
            opacity: 0; transform: translateY(10px); transition: all 0.8s ease;
            margin-bottom: 15px; text-align: justify;
        }
        .letter-p.show { opacity: 1; transform: translateY(0); }
        
        #letter-hint {
            margin-top: auto; text-align: center; color: #999; font-size: 12px;
            padding-top: 10px; animation: blink 1.5s infinite;
        }
        @keyframes blink { 0% {opacity:0.3} 50% {opacity:1} 100% {opacity:0.3} }

        #finish-letter-btn {
            display: none; text-align: right; margin-top: 20px; color:#ff4757; 
            font-weight:bold; cursor: pointer; padding: 10px;
        }

        /* ç›¸å†Œ */
        #album-layer {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .polaroid {
            position: relative; width: 80%; max-width: 320px; background: white; padding: 10px 10px 50px 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); transform: rotate(-2deg);
            text-align: center; cursor: pointer; transition: transform 0.3s;
        }
        .photo-area {
            width: 100%; height: 0; padding-bottom: 80%;
            background-color: #eee; margin-bottom: 10px;
            background-size: cover; background-position: center; border: 1px solid #ddd;
        }
        .photo-text { color: #333; font-size: 14px; line-height: 1.4; white-space: pre-wrap; margin-top:10px;}
        .photo-date { position: absolute; bottom: 8px; right: 10px; font-size: 12px; color: #888; }

        /* å¯¹è¯æ¡† */
        #dialog-box {
            display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 600px; background: rgba(255, 255, 255, 0.95);
            border-radius: 15px; border: 3px solid #ff9a9e; padding: 15px 15px 15px 100px; 
            box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100;
        }
        #char-avatar {
            position: absolute; left: -10px; bottom: 10px;
            width: 100px; height: 100px; 
            background-color: #eee; border-radius: 10px;
            background-size: cover; background-position: center;
            border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none; 
        }
        #char-name { font-weight: bold; color: #d6336c; font-size: 18px; margin-bottom: 5px; }
        #dialog-text { font-size: 16px; line-height: 1.5; color: #333; }
        
        #game-over {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; text-align: center; z-index: 200; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; width: 80%;
        }
        #final-title {
            display: none; color: white; text-align: center; font-size: 24px; font-weight: bold; line-height: 1.5;
            text-shadow: 0 2px 10px rgba(255, 71, 87, 0.6);
        }
    </style>
</head>
<body>

    <!-- ğŸµ éŸ³ä¹ç»„ä»¶ -->
    <audio id="bgm2" src="pingxing.mp3" loop preload="auto"></audio>

    <canvas id="gameCanvas"></canvas>

    <div id="game-ui">
        <div class="bar-row">
            <div class="bar-label">ç”Ÿå‘½å€¼</div>
            <div class="bar-container"><div class="bar-fill" id="hp-fill"></div></div>
        </div>
        <div class="bar-row">
            <div class="bar-label" id="energy-label">èƒ½é‡âš¡</div>
            <div class="bar-container"><div class="bar-fill" id="energy-fill"></div></div>
        </div>
    </div>

    <div id="subtitle"></div>

    <div id="transition-layer">
        <div id="choice-container">
            <button class="choice-btn" id="btn-yes" onclick="chooseYes()">æ„¿æ„</button>
            <button class="choice-btn" id="btn-no" onmouseover="runAway()" onclick="runAway()">ä¸æ„¿æ„</button>
        </div>
    </div>

    <!-- âœ‰ï¸ ä¿¡ä»¶å±‚ (ä¿®æ”¹äº†ç»“æ„ä»¥æ”¯æŒåˆ†æ®µæ˜¾ç¤º) -->
    <div id="letter-layer" style="display:none;" onclick="nextLetterPart()">
        <div id="letter-paper" onclick="nextLetterPart()">
            <!-- å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
            <div id="letter-content-area"></div>
            
            <div id="letter-hint">â–¼ ç‚¹å‡»å±å¹•ç»§ç»­é˜…è¯» â–¼</div>
            <div id="finish-letter-btn">[ç‚¹å‡»æŸ¥çœ‹ç›¸å†Œ]</div>
        </div>
    </div>

    <div id="album-layer" style="display:none;" onclick="nextPhoto()">
        <div class="polaroid" id="polaroid-card">
            <div class="photo-area" id="p-img"></div>
            <div class="photo-text" id="p-text"></div>
            <div class="photo-date" id="p-date"></div>
        </div>
        <div id="final-title">
            é˜¿é“­ï¼Œæƒ…äººèŠ‚å¿«ä¹ï¼<br><span style='font-size:20px'>â€”â€”çˆ±ä½ çš„è¯ºå­</span>
        </div>
    </div>

    <div id="dialog-box" onclick="nextDialog()">
        <div id="char-avatar"></div>
        <div id="char-name"></div>
        <div id="dialog-text"></div>
        <div style="text-align: right; font-size: 12px; color: #999;">ç‚¹å‡»ç»§ç»­ â–¶</div>
    </div>

    <div id="game-over">
        <h2>éœ€è¦æ›´å¤šèƒ½é‡!</h2><p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é‡æ¥</p>
        <button onclick="location.reload()" style="padding:10px 20px; font-size:16px;">é‡æ–°å¼€å§‹</button>
    </div>

    <script>
        // ==========================================
        // é…ç½®åŒº
        // ==========================================
        const CONFIG = {
            aming_avatar: 'aming.jpg',
            nuozi_avatar: 'nuozi.jpg',
            car_img: 'car.png',    
            end_bg: 'end_bg.jpg', 
            
            photos: [
                { t: "æˆ‘ä»¬ä¸€èµ·åšçš„ç¬¬ä¸€æ£µåœ£è¯æ ‘", d: "2022.12.25", img: 'p1.jpg' },
                { t: "ä½ ç”»çš„æˆ‘", d: "2023.9.25", img: 'p2.jpg' },
                { t: "æˆ‘ä»¬åœ¨æˆ‘çš„ä¸–ç•Œé‡Œå»ºçš„å°å®¶", d: "2023.10.6", img: 'p3.jpg' },
                { t: "ç»™ä½ å†™çš„æ­Œ", d: "2024.3.29", img: 'p4.jpg' },
                { t: "è¿™æ˜¯æˆ‘ä»¬çš„ä¸åˆ†æ‰‹åˆçº¦", d: "2025.4.2", img: 'p5.jpg' },
                { t: "æˆ‘ä»¬ç»ˆäºè§é¢äº†ï¼", d: "2026.1.10è‡³1.11", img: 'p6.jpg' }
            ]
        };

        // ğŸ’Œ ä¿¡ä»¶å†…å®¹æ•°ç»„ (åˆ†æ®µæ˜¾ç¤º)
        const letterTexts = [
            "é˜¿é“­ï¼Œè§å­—å¦‚é¢ã€‚",
            "æˆ‘ä»¬å°±åƒæ¸¸æˆé‡Œé‚£æ ·ä¸€èµ·èµ°å‡ºäº†å¥½è¿œï¼Œè¶Šè¿‡äº†å¥½å¤šçš„é˜»ç¢ï¼Œæˆ‘çœŸæƒ³åœ¨ç°å®ä¸­å’Œä½ ä¸€èµ·è‡ªé©¾æ¸¸ä¸€æ¬¡ï¼Œä¸€èµ·æ¬£èµæ²¿é€”çš„ç¾æ™¯ï¼Œä½†å®é™…ä¸Šä½ å¯¹æˆ‘è€Œè¨€å°±æ˜¯æœ€ç¾çš„æ™¯è‰²ã€‚æœªæ¥çš„é“è·¯æ²¡æœ‰å°½å¤´ï¼Œæˆ‘ä»¬è¿˜æœ‰å¥½å¤šçš„æ—¶é—´ã€‚",
            "è¿™æ˜¯æˆ‘ä»¬è¿‡çš„ç¬¬å››ä¸ªæƒ…äººèŠ‚ï¼Œè€Œæˆ‘ä»Šå¤©æ‰ææ¸…æ¥šäº†æƒ…äººèŠ‚å’Œä¸ƒå¤•çš„åŒºåˆ«ï¼Œä½†æ˜¯å¯¹äºæˆ‘ä»¬æ¥è¯´å…¶å®åˆæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæˆ‘æ›¾ç»è¯´ä½ æ˜¯æˆ‘ä¸–ç•Œä¹‹å¤–åˆæ˜¯æˆ‘ä¸–ç•Œä¹‹å†…çš„äººï¼Œè¿™å¥è¯çš„è¿™ä¸¤ä¸ªä¸–ç•Œä¸€ä¸ªä»£è¡¨ä¸–ä¿—çš„ä¸–ç•Œï¼Œä¸€ä¸ªä»£è¡¨æˆ‘å†…å¿ƒçš„ä¸–ç•Œï¼Œè€Œä½ å°±æ˜¯è¿œç¦»ä¸–ä¿—ä¸–ç•Œè€Œç›´æ¥è¿›å…¥æˆ‘å†…å¿ƒä¸–ç•Œçš„äººã€‚",
            "æ‰€ä»¥è™½ç„¶æˆ‘ä»¬ç›®å‰ç¡®å®å—ç€ç°å®æƒ…å†µçš„å½±å“ï¼Œä½†æˆ‘æƒ³æˆ‘ä»¬ä»ç„¶èƒ½å¤Ÿç›´æ¥æŠµè¾¾å¯¹æ–¹ï¼Œå› ä¸ºæˆ‘ä»¬ç»•è¿‡äº†ç°å®ï¼Œç›´æ¥å­˜åœ¨äºå¯¹æ–¹çš„ä¸–ç•Œä¸­ï¼Œå¿ƒæ„ç›¸é€šã€‚",
            "æˆ‘ç»å†äº†ä¸€ä¸ªä»çœŸæ­£çš„å°å­©ï¼Œåˆ°å°†è‡ªå·±ä¼ªè£…æˆå¤§äººï¼Œå†åˆ°å‘ç°è‡ªå·±å†…å¿ƒå…¶å®ä»ç„¶è¿˜æ˜¯ä¸€ä¸ªå°å­©çš„è¿‡ç¨‹ã€‚ä¸çŸ¥é“ä½ è¿˜è®°ä¸è®°å¾—ï¼Œæˆ‘ä¹‹å‰è¯´æˆ‘æƒ³å½“ä¸€ä¸ªæˆç†Ÿçš„ç”·äººï¼Œæˆ‘æƒ³å½“ä¸€ä¸ªåœ¨ä»»ä½•äº‹ä¸Šéƒ½æ¸¸åˆƒæœ‰ä½™çš„äººï¼Œä½†æˆ‘ç°åœ¨å‘ç°æˆ‘å½“ä¸äº†è¿™æ ·çš„äººï¼Œæˆ‘ä»å°å°±æ˜¯åœ¨è¢«ä¿æŠ¤çš„ç¯å¢ƒä¸‹é•¿å¤§çš„ï¼Œä¸Šäº†å¤§å­¦ä¹‹åï¼Œæˆ‘é¢å¯¹å„ç§å„æ ·çš„ç³Ÿç³•æƒ…å†µæ—¶ï¼Œæ‰€æœ‰äº‹å®éƒ½åœ¨å‘æˆ‘è¡¨æ˜ï¼Œæˆ‘ç°åœ¨æ‰€çœ‹åˆ°çš„æ‰æ˜¯çœŸæ­£çš„ä¸–ç•Œçš„ä¸€è§’ï¼Œè€Œè¿™åªæ˜¯ä¸€ä¸ªå¼€å§‹ã€‚",
            "æˆ‘åªæ˜¯ä¸€ä¸ªå­©å­ï¼Œä¸€ä¸ªæ— æ³•æŠŠä¸€äº›å¤„ç†å¾—æ¸¸åˆƒæœ‰ä½™çš„å­©å­ï¼Œæˆ‘å¹¶æ²¡æœ‰æ¥çº³è¿™æ ·çš„è‡ªå·±ï¼Œä½†æ˜¯ä½ æ¥çº³äº†è¿™æ ·çš„æˆ‘ï¼Œæˆ‘å¯ä»¥è‚†æ— å¿Œæƒ®çš„åœ¨ä½ è¿™é‡Œå°±å½“ä¸€ä¸ªå­©å­ã€‚",
            "è¿™ä¸ªç§‹å¤©çœŸæ˜¯ä¸€ä¸ªæƒ…æ„Ÿå—æŒ«çš„å­£èŠ‚ï¼Œæˆ‘å‘¨å›´çš„è®¸å¤šäººéƒ½ç»å†äº†åˆ†æ‰‹ï¼Œä½†å€¼å¾—åº†å¹¸çš„æ˜¯æˆ‘ä»¬æŒºè¿‡å»äº†ï¼Œè€Œä¸”æˆ‘ä»¬çš„æ„Ÿæƒ…ä¹Ÿè¿æ¥äº†å‡çº§ã€‚",
            "æˆ‘æƒ³å¯¹ä½ è¯´çš„æ˜¯ï¼Œè™½ç„¶ä¸Šæ¬¡æˆ‘è‡ªå·±è·‘åˆ°æ²³å—å»æ²¡è§åˆ°ä½ ï¼Œä½†æ˜¯æˆ‘å»é‚£è¾¹çœŸçš„çœŸçš„å¾ˆå¼€å¿ƒï¼Œä¸€æ–¹é¢æˆ‘å»çš„æ˜¯ä½ çš„åŸå¸‚ï¼Œé‚£æ—¶æˆ‘å°±è§‰å¾—ç¦»ä½ å¾ˆè¿‘ï¼Œå¦ä¸€æ–¹é¢è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡è‡ªå·±ä¸€ä¸ªäººå»å¦å¤–çš„ä¸€ä¸ªåŸå¸‚ï¼Œæˆ‘éå¸¸äº«å—è¿™ä¸ªè¿‡ç¨‹ã€‚",
            "ä½†æ— è®ºæ€ä¹ˆæ ·ï¼Œæˆ‘éƒ½æ²¡æ–™åˆ°ä½ ä¼šåœ¨ä¸€ä¸ªæ¯«æ— é¢„å…†çš„å¹³å‡¡çš„ä¸€å¤©ä¸­çªç„¶å‡ºç°åœ¨æˆ‘çš„åŸå¸‚ï¼Œè®©è¿™å¤©å˜å¾—æ— ä¸ä¼¦æ¯”çš„æ¢¦å¹»ï¼Œè®©æˆ‘å¼±å°çš„å†…å¿ƒè¢«æµ“å¯†çš„çˆ±åŒ…è£¹ã€‚",
            "åœ¨é‚£æ£µæ ‘ä¸‹æˆ‘å°å¿ƒç¿¼ç¿¼çš„æŠ±ç€ä½ ï¼Œå°±åƒæ˜¯æˆ‘æŠ±ç€ä¸€ä¸ªå°å°çš„å°å®å®ï¼Œé‚£ä¹ˆå¯’å†·çš„å¤©ï¼Œä½ èµ°è¿‡äº†é‚£ä¹ˆå¤šè·¯ï¼Œåˆ°é‚£æ—¶èµ°ä¸€å°æ­¥å°±å·²ç»æ‘‡æ‘‡æ¬²å ï¼Œåœ¨æˆ‘çš„æ€€é‡Œé¢ é¢ å€’å€’ï¼Œåƒä¸ªè½¯ç»µç»µçš„å°ä¼é¹…ä¸€æ ·ï¼Œæˆ‘å½“æ—¶çœŸæ˜¯åˆè§‰å¾—ä½ å¤ªå¯çˆ±äº†ï¼Œåˆè§‰å¾—å®åœ¨æ˜¯å¿ƒç–¼ã€‚",
            "æˆ‘æ‹¿å‡ºæˆ‘çš„æ‰‹å¥—ç»™ä½ æˆ´ä¸Šï¼Œä½ é‚£åŒå°å°çš„æ‰‹æˆ´ç€å¤§å¤§çš„æ‰‹å¥—ï¼Œé‚£æ‰‹å¥—æ‰‹æŒ‡å‰é¢å¤šå‡ºæ¥çš„éƒ¨åˆ†åœ¨ç©ºä¸­ä¹±ä¸ƒå…«ç³Ÿçš„è€·æ‹‰ç€ï¼Œæˆ–æ˜¯å²”äº†å‡ºæ¥ï¼Œå¯’å†·ä¸­ä½ çš„åŠ¨ä½œæ…¢æ…¢çš„ï¼Œåƒä¸ªå­©ç«¥èˆ¬å°†ä¸¤åªå°æ‰‹æˆ³åœ¨ä¸€èµ·ï¼Œç©å¼„ç€æ‰‹å¥—å¤šå‡ºæ¥çš„éƒ¨åˆ†ï¼ŒçœŸåƒä¸ªå¯çˆ±çš„å°å®å®ï¼Œæˆ‘çœŸå–œæ¬¢æˆ‘çš„å°å®å®ï¼Œäºæ˜¯æˆ‘æŠ±çš„ä¸çŸ¥ä¸è§‰æ›´ç´§äº†ï¼Œå¯¼è‡´ä½ æ•´ä¸ªèº«ä½“ä»°ç€å€’åœ¨æˆ‘æ€€é‡Œã€‚",
            "ä½ ä¸Šè½¦ç¦»å¼€ä¹‹åï¼Œæˆ‘ä¸€ä¸ªäººå›åˆ°æ•™å®¤åšæˆ‘çš„é›•å¡‘ï¼Œæˆ‘å½“æ—¶è§‰å¾—ä¸€åˆ‡ä»…å‘ç”Ÿåœ¨ä¸€ç¬é—´ï¼Œä¸€çœ¨çœ¼çš„åŠŸå¤«æˆ‘åˆè¦é¢å¯¹è¿™äº›è¯¥æ­»çš„ä½œä¸šäº†ï¼Œåšæ¢¦åªåšäº†ä¸€å°ä¼šã€‚æˆ‘ä¹Ÿæ²¡æœ‰æƒ³åˆ°ä½ ä¼šæƒ³è¦æˆ‘ç›´æ¥å»ä½ ä½çš„åœ°æ–¹ï¼Œæˆ‘ä»¬åœ¨é‚£é‡Œåˆåº¦è¿‡äº†æ¢¦å¹»èˆ¬çš„å¤œæ™šã€‚",
            "æœ‰æ—¶å€™æˆ‘çœŸçš„å¾ˆå®³æ€•è¿™ä¸ªä¸–ç•Œï¼Œè¿œç¦»è¿™ä¸ªä¸–ç•Œæˆ‘åˆä¸çŸ¥é“è¯¥æ€æ ·è‡ªå±…ï¼Œæ‰€ä»¥æˆ‘æ˜¯çœŸçš„å¾ˆæƒ³è¦ä½ æ—¶åˆ»éƒ½æŠ±ç´§æˆ‘ï¼Œæ—¶åˆ»è®©æˆ‘é™·å…¥æŸ”è½¯å’Œæ¸©æš–ä¸­ï¼Œè·Ÿä½ å‘†åœ¨ä¸€èµ·æˆ‘ä»€ä¹ˆçƒ¦å¿ƒäº‹éƒ½æ²¡æœ‰æƒ³èµ·æ¥ï¼Œå°±åªæƒ³ä¸€ç›´ç²˜ç€ä½ ï¼ŒçœŸå¸Œæœ›æˆ‘ä»¬èƒ½å¤Ÿä¸€ç›´ä¸€ç›´åœ¨ä¸€èµ·ä¸å†åˆ†å¼€ã€‚",
            "ä½†ä¸å¾—ä¸è¯´å…¶å®ä¸Šæ¬¡æˆ‘ä»¬çŸ­æš‚çš„çŸ›ç›¾è®©æˆ‘ä»¬å˜å¾—æ›´åŠ ç´§å¯†äº†ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ç§é€‚åˆæˆ‘ä»¬ç›¸å¤„çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯¹å¯¹æ–¹éƒ½æœ‰ä¸ªäº²æ˜µçš„æ˜µç§°ï¼Œä»»ä½•æ—¶å€™ï¼Œæ— è®ºåœ¨è°ˆè®ºä»€ä¹ˆï¼Œæˆ–ä¸¥è‚ƒæˆ–æ”¾æ¾ï¼Œè¿™ç§æ˜µç§°ä»£è¡¨ä¸€ç§æ€åº¦ï¼Œä»£è¡¨æˆ‘ä»¬éƒ½åœ¨å¿ƒå¹³æ°”å’Œçš„ä¸å¯¹æ–¹äº¤æµï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¾ˆå¤šçš„è¯¯ä¼šï¼Œæœ‰ä»€ä¹ˆæ˜¯ä¸èƒ½å¿ƒå¹³æ°”å’Œçš„èŠèŠæˆ–è€…æ’’ä¸ªå¨‡å–ä¸ªèŒè§£å†³çš„å‘¢ï¼Ÿ",
            "æƒ…äººèŠ‚å¿«ä¹ï¼æˆ‘æœ€çˆ±çš„å°å®è´ç‹é“­è±ï¼Œå¸Œæœ›æˆ‘ä»¬ä¸€ç›´ä¸€ç›´åœ¨ä¸€èµ·ï¼Œæˆ‘æ°¸è¿œæ°¸è¿œçˆ±ä½ ï¼",
            "2026.2.14"
        ];

        let letterIndex = 0;
        let isLetterFinished = false;

        function nextLetterPart() {
            if (isLetterFinished) {
                // å¦‚æœä¿¡è¯»å®Œäº†ï¼Œç‚¹å‡»å°±å…³é—­ä¿¡ä»¶ï¼Œè¿›å…¥ç›¸å†Œ
                closeLetter();
                return;
            }

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å†…å®¹
            if (letterIndex < letterTexts.length) {
                const container = document.getElementById('letter-content-area');
                const p = document.createElement('p');
                p.className = 'letter-p';
                p.innerText = letterTexts[letterIndex];
                container.appendChild(p);

                // å¼ºåˆ¶é‡ç»˜è§¦å‘ transition
                setTimeout(() => p.classList.add('show'), 50);

                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                const paper = document.getElementById('letter-paper');
                setTimeout(() => {
                    paper.scrollTo({ top: paper.scrollHeight, behavior: 'smooth' });
                }, 100);

                letterIndex++;
            } else {
                // å†…å®¹å…¨éƒ¨æ˜¾ç¤ºå®Œæ¯•
                isLetterFinished = true;
                document.getElementById('letter-hint').style.display = 'none';
                document.getElementById('finish-letter-btn').style.display = 'block';
                
                // å†æ»šä¸€æ¬¡åˆ°åº•éƒ¨ç¡®ä¿çœ‹åˆ°æŒ‰é’®
                const paper = document.getElementById('letter-paper');
                setTimeout(() => {
                    paper.scrollTo({ top: paper.scrollHeight, behavior: 'smooth' });
                }, 100);
            }
        }

        // --- ğŸµ éŸ³ä¹æ’­æ”¾é€»è¾‘ ---
        function tryPlayMusic2() {
            var audio = document.getElementById('bgm2');
            if (audio.paused) {
                audio.volume = 0.5;
                audio.play().catch(e => console.log("ç­‰å¾…äº¤äº’..."));
            }
        }
        document.body.addEventListener('click', tryPlayMusic2);
        document.body.addEventListener('touchstart', tryPlayMusic2);

        // ==========================================
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = 'INTRO'; 
        let lastTime = 0;
        
        const player = { x: 0, y: 0, w: 0, h: 0, hp: 100, energy: 100 };
        let items = [];
        let isGameOver = false;

        const SCROLL_SPEED = 400; 
        const PHASE_1_DURATION = 30; 
        let phase1Timer = 0;
        let stopSpawning = false;

        // å›¾ç‰‡åŠ è½½
        const carImg = new Image();
        let carLoaded = false;
        carImg.onload = () => { carLoaded = true; };
        carImg.onerror = () => { carLoaded = false; };
        if(CONFIG.car_img) carImg.src = CONFIG.car_img;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            player.w = canvas.width * 0.12; 
            player.h = player.w * 1.6;
            player.x = canvas.width / 2 - player.w / 2;
            player.y = canvas.height - player.h - 50;
        }
        window.addEventListener('resize', resize);
        resize();

        // å‰§æœ¬
        const introScript = [
            {n:"é˜¿é“­", t:"èµ°å§ï¼Œè¯´å¥½çš„è‡ªé©¾æ¸¸ï¼", img: CONFIG.aming_avatar},
            {n:"è¯ºå­", t:"ç«‹åˆ»å°±å‡ºå‘ï¼", img: CONFIG.nuozi_avatar},
            {n:"è¯ºå­", t:"æ§åˆ¶æ±½è½¦å·¦å³ç§»åŠ¨ï¼Œèº²é¿éšœç¢ç‰©å¹¶æ¡èµ·èƒ½é‡ï¼Œå¯ä¸èƒ½è®©è½¦æ²¡ç”µæŠ›é”šï¼", img: CONFIG.nuozi_avatar}
        ];
        
        const endScript = [
            {n:"è¯ºå­", t:"æˆ‘ä»¬åˆ°å•¦ï¼", img: CONFIG.nuozi_avatar},
            {n:"é˜¿é“­", t:"å¥½æ¼‚äº®å‘€ï¼å¦‚æœæˆ‘ä»¬ä¸€èµ·ç”Ÿæ´»åœ¨è¿™æ ·ç¾ä¸½çš„åœ°æ–¹å°±å¥½å•¦", img: CONFIG.aming_avatar},
            {n:"è¯ºå­", t:"æˆ‘ä»¬ä¸€å®šä¼šçš„ã€‚", img: CONFIG.nuozi_avatar},
            {n:"è¯ºå­", t:"é˜¿é“­ï¼Œæƒ…äººèŠ‚å¿«ä¹ï¼", img: CONFIG.nuozi_avatar},
            {n:"è¯ºå­", t:"ä½ æ„¿ä¸æ„¿æ„ä¸€ç›´ä¸€ç›´å’Œæˆ‘åœ¨ä¸€èµ·å‘€ï¼Ÿ", img: CONFIG.nuozi_avatar}
        ];

        let scriptIdx = 0;

        function showDialog(list, onFinish) {
            const box = document.getElementById('dialog-box');
            if(scriptIdx >= list.length) {
                box.style.display = 'none';
                if(onFinish) onFinish();
                return;
            }
            box.style.display = 'block';
            tryPlayMusic2(); 
            
            const item = list[scriptIdx];
            document.getElementById('char-name').innerText = item.n;
            document.getElementById('dialog-text').innerText = item.t;
            
            const av = document.getElementById('char-avatar');
            const boxStyle = document.getElementById('dialog-box');
            if(item.img) {
                av.style.display = 'block';
                av.style.backgroundImage = `url(${item.img})`;
                boxStyle.style.paddingLeft = '100px'; 
            } else {
                av.style.display = 'none';
                boxStyle.style.paddingLeft = '15px';
            }
        }

        function nextDialog() {
            if(gameState === 'INTRO') {
                scriptIdx++;
                showDialog(introScript, startGame1);
            } else if (gameState === 'END_SCENE') {
                scriptIdx++;
                showDialog(endScript, showChoice);
            }
        }

        showDialog(introScript);

        function startGame1() {
            gameState = 'GAME1';
            document.getElementById('game-ui').style.display = 'block'; 
            lastTime = Date.now();
            requestAnimationFrame(gameLoop);
            
            canvas.addEventListener('touchmove', e => { 
                e.preventDefault(); 
                let touchX = e.touches[0].clientX;
                player.x = touchX - player.w/2; 
            }, {passive: false});
        }

        function gameLoop() {
            if(isGameOver) return;
            const now = Date.now();
            const dt = (now - lastTime) / 1000;
            lastTime = now;
            update(dt);
            draw(ctx);
            if(['GAME1','GAME2','TRANSITION'].includes(gameState)) requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            if(player.x < 0) player.x = 0;
            if(player.x > canvas.width - player.w) player.x = canvas.width - player.w;

            if(gameState === 'GAME1') {
                phase1Timer += dt;
                player.energy -= dt * 3.5; 
                if(player.hp <= 0 || player.energy <= 0) {
                    isGameOver = true;
                    document.getElementById('game-over').style.display = 'block';
                    return;
                }
                if(phase1Timer >= PHASE_1_DURATION && !stopSpawning) startMidTalkSeamless();
                if(!stopSpawning) spawnItems(dt, 'OBSTACLE', 'LIGHTNING');
            }

            if(gameState === 'GAME2') {
                if(player.energy >= 100) startTransition();
                if(!stopSpawning) spawnItems(dt, 'HEARTBREAK', 'HEART');
            }
            
            if(gameState === 'TRANSITION') player.y -= dt * 200; 

            for(let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.y += SCROLL_SPEED * dt;
                
                if(rectIntersect(player.x + player.w*0.1, player.y + player.h*0.1, player.w*0.8, player.h*0.8, item.x, item.y, item.w, item.h)) {
                    handleCollision(item);
                    items.splice(i, 1);
                    continue;
                }
                if(item.y > canvas.height) items.splice(i, 1);
            }
            updateUI();
        }

        function spawnItems(dt, badType, goodType) {
            if(Math.random() < dt * 1.8) { 
                const isGood = Math.random() > 0.6; 
                let item = { y: -200, type: isGood ? goodType : badType };

                if (badType === 'OBSTACLE' && !isGood) {
                    item.w = canvas.width * (0.15 + Math.random() * 0.1); 
                    item.h = item.w * (0.8 + Math.random() * 0.5);
                    item.x = Math.random() * (canvas.width - item.w);
                    const c = 50 + Math.random() * 30;
                    item.color = `rgb(${c}, ${c}, ${c+10})`; 
                } else {
                    item.w = canvas.width * 0.1; 
                    item.h = item.w;
                    item.x = 20 + Math.random() * (canvas.width - item.w - 40);
                    item.txt = isGood ? (goodType==='LIGHTNING'?'âš¡':'â¤ï¸') : 'ğŸ’”';
                }
                if(items.length > 0) {
                    let last = items[items.length-1];
                    if(Math.abs(last.y - item.y) < 150) return; 
                }
                items.push(item);
            }
        }

        function handleCollision(item) {
            if(item.type === 'OBSTACLE') {
                player.hp -= 20;
                shakeScreen();
            } else if (item.type === 'LIGHTNING') {
                player.energy = Math.min(100, player.energy + 20);
            } else if (item.type === 'HEARTBREAK') {
                player.energy = Math.max(0, player.energy - 10);
                shakeScreen();
            } else if (item.type === 'HEART') {
                player.energy = Math.min(100, player.energy + 10);
            }
        }

        function draw(ctx) {
            ctx.fillStyle = '#333'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            for(let item of items) {
                if (item.type === 'OBSTACLE') {
                    ctx.fillStyle = item.color;
                    ctx.fillRect(item.x, item.y, item.w, item.h);
                    ctx.fillStyle = '#222';
                    ctx.fillRect(item.x + 5, item.y + 5, item.w - 10, item.h - 10);
                } else {
                    ctx.font = `${parseInt(item.w)}px Arial`;
                    ctx.textAlign = "center";
                    ctx.fillStyle = "#fff"; 
                    ctx.fillText(item.txt, item.x + item.w/2, item.y + item.h);
                }
            }

            if(gameState === 'GAME2' || gameState === 'TRANSITION') {
                ctx.font = `${parseInt(player.w)}px Arial`;
                ctx.textAlign = "center";
                ctx.fillText("ğŸ‘©â€â¤ï¸â€ğŸ‘¨", player.x + player.w/2, player.y + player.h/1.5);
            } else {
                if(carLoaded) {
                    ctx.drawImage(carImg, player.x, player.y, player.w, player.h);
                } else {
                    ctx.font = `${parseInt(player.w)}px Arial`;
                    ctx.textAlign = "center";
                    ctx.fillText("ğŸš—", player.x + player.w/2, player.y + player.h/1.2);
                }
            }
        }

        function updateUI() {
            document.getElementById('hp-fill').style.width = player.hp + '%';
            document.getElementById('energy-fill').style.width = player.energy + '%';
        }

        function shakeScreen() {
            canvas.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
            setTimeout(()=>canvas.style.transform='none', 200);
        }

        function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
            return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
        }

        function startMidTalkSeamless() {
            stopSpawning = true; 
            const sub = document.getElementById('subtitle');
            sub.innerText = "è¯ºå­ï¼šé˜¿é“­ï¼Œä½ æœ‰æ²¡æœ‰è§‰å¾—è¿™ä¸ªå¼€è½¦çš„è¿‡ç¨‹ï¼Œå°±åƒæ˜¯æˆ‘ä»¬ä¸¤ä¸ªåšæ¯…åœ°æ’é™¤ç”Ÿæ´»ä¸­çš„ç§ç§å›°éš¾ä¸€ç›´èµ°ä¸‹å»ï¼Ÿ";
            sub.style.opacity = 1;
            
            setTimeout(()=>{
                sub.innerText = "è¯ºå­ï¼šæˆ‘è§‰å¾—å¾ˆåƒï¼Œä½ çœ‹";
                setTimeout(()=>{
                    gameState = 'GAME2';
                    stopSpawning = false; 
                    player.energy = 0; 
                    document.getElementById('energy-label').innerHTML = "çˆ±å¿ƒâ¤ï¸";
                    document.getElementById('energy-fill').style.background = "#ff6b81";

                    sub.innerText = "æ”¶é›†çˆ±å¿ƒï¼Œè¿œç¦»å¿ƒç¢ï¼";
                    sub.style.bottom = "auto"; 
                    sub.style.top = "15%";    
                    sub.style.fontSize = "22px";
                    sub.style.color = "#ff4757"; 
                    sub.style.fontWeight = "bold";
                    sub.style.textShadow = "0 0 10px white";
                    
                    setTimeout(() => { sub.style.opacity = 0; }, 3000);

                }, 3000); 
            }, 6000); 
        }

        function startTransition() {
            gameState = 'TRANSITION';
            const layer = document.getElementById('transition-layer');
            layer.style.display = 'flex';
            setTimeout(() => { layer.style.opacity = 1; }, 100);
            setTimeout(() => {
                if(CONFIG.end_bg) layer.style.backgroundImage = `url(${CONFIG.end_bg})`;
                gameState = 'END_SCENE';
                scriptIdx = 0;
                showDialog(endScript, showChoice);
            }, 3000);
        }

        function showChoice() {
            document.getElementById('choice-container').style.display = 'block';
        }

        function runAway() {
            const btn = document.getElementById('btn-no');
            const maxX = window.innerWidth - 100;
            const maxY = window.innerHeight - 100;
            const x = Math.random() * (maxX - 50); 
            const y = Math.random() * (maxY - 300); 
            
            btn.style.position = 'fixed';
            btn.style.left = x + 'px';
            btn.style.top = y + 'px';
            btn.style.bottom = 'auto';
            btn.style.right = 'auto';
        }

        function chooseYes() {
            document.getElementById('choice-container').style.display = 'none';
            const letter = document.getElementById('letter-layer');
            letter.style.display = 'flex';
            
            // æ”¾å¤§ä¿¡çº¸å¹¶å¼€å§‹æ˜¾ç¤ºç¬¬ä¸€æ®µ
            setTimeout(() => { 
                document.getElementById('letter-paper').style.transform = "scale(1)";
                // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹æ˜¾ç¤ºç¬¬ä¸€æ®µ
                setTimeout(nextLetterPart, 500);
            }, 50);
        }

        function closeLetter() {
            document.getElementById('letter-layer').style.display = 'none';
            startAlbum();
        }

        function startAlbum() {
            gameState = 'ALBUM';
            const album = document.getElementById('album-layer');
            album.style.display = 'flex';
            album.onclick = nextPhoto;
            loadPhoto(0);
        }

        let photoIdx = 0;
        function loadPhoto(index) {
            if(index >= CONFIG.photos.length) {
                document.getElementById('polaroid-card').style.display = 'none';
                document.getElementById('final-title').style.display = 'block';
                return;
            }
            const data = CONFIG.photos[index];
            document.getElementById('p-text').innerText = data.t;
            document.getElementById('p-date').innerText = data.d;
            const imgDiv = document.getElementById('p-img');
            if(data.img) imgDiv.style.backgroundImage = `url(${data.img})`;
        }

        function nextPhoto() {
            if(gameState !== 'ALBUM') return;
            if(photoIdx >= CONFIG.photos.length) return; 
            
            const card = document.getElementById('polaroid-card');
            card.style.transform = "translateX(-150%) rotate(-20deg)"; 
            setTimeout(()=>{
                photoIdx++;
                loadPhoto(photoIdx);
                card.style.transition = 'none';
                card.style.transform = "translateX(150%) rotate(20deg)";
                setTimeout(()=>{
                    card.style.transition = 'transform 0.3s';
                    card.style.transform = "translateX(0) rotate(-2deg)";
                }, 50);
            }, 300);
        }
    </script>
</body>
</html>
